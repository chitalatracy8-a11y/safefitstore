<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messages & Notifications - SafeFit</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f0f4f8;
        margin: 0;
        padding: 0;
    }

    .navbar {
        background-color: #2c3e50;
        padding: 1rem;
        color: #fff;
        text-align: center;
    }

    .container {
        padding: 20px;
        max-width: 900px;
        margin: auto;
    }

    .message-box {
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid #3498db;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .message-box.unread { background: #ecf0f1; }
    .message-box.read { background: #fff; }

    .message-box h4 {
        margin: 0 0 5px;
        color: #2c3e50;
    }

    .message-box p {
        margin: 0;
        color: #555;
    }

    .date {
        font-size: 0.85em;
        color: #777;
        margin-top: 5px;
    }

    .delete-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #e74c3c;
        border: none;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .delete-btn:hover {
        background: #c0392b;
    }

    .back-link {
        display: inline-block;
        margin-top: 20px;
        text-decoration: none;
        color: #3498db;
        font-weight: bold;
    }

    .back-link:hover {
        text-decoration: underline;
    }
</style>
</head>
<body>

<div class="navbar">
    <h2>Messages & Notifications</h2>
</div>

<div class="container" id="messages-container">
    <!-- Messages will be loaded dynamically here -->
</div>

<a href="admin_dashboard.html" class="back-link">‚Üê Back to Dashboard</a>

<script>
const token = localStorage.getItem('token'); // JWT token stored after login

if (!token) {
    alert("You must be logged in as admin to view messages.");
    window.location.href = "login.html";
}

const container = document.getElementById('messages-container');

async function loadMessages() {
    try {
        const res = await fetch('http://localhost:5000/api/messages', {
            headers: { 'Authorization': 'Bearer ' + token }
        });

        const messages = await res.json();
        container.innerHTML = "";

        if (messages.length > 0) {
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.classList.add('message-box', msg.read ? 'read' : 'unread');
                div.innerHTML = `
                    <h4>${msg.name} (${msg.email})</h4>
                    <p>${msg.message}</p>
                    <div class="date">Posted on: ${new Date(msg.created_at).toLocaleString()}</div>
                    <button class="delete-btn" data-id="${msg.id}">Delete</button>
                `;
                container.appendChild(div);
            });

            // Delete functionality
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    if (confirm("Are you sure you want to delete this message?")) {
                        try {
                            const delRes = await fetch(`http://localhost:5000/api/messages/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': 'Bearer ' + token }
                            });
                            const delData = await delRes.json();
                            if(delData.success){
                                alert("Message deleted successfully.");
                                loadMessages();
                            } else {
                                alert("Failed to delete message.");
                            }
                        } catch(err) {
                            alert("Error: " + err.message);
                        }
                    }
                });
            });
        } else {
            container.innerHTML = '<p>No messages found.</p>';
        }
    } catch(err) {
        console.error(err);
        container.innerHTML = "<p>Error loading messages.</p>";
    }
}

// Initial load
loadMessages();
</script>

</body>
</html>

